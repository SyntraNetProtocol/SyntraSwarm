<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css">
    <style>
        /* Assicura che il body e html occupino il 100% dell'altezza e larghezza del viewport */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%; /* Copre completamente la larghezza */
            height: 100%; /* Copre completamente l'altezza */
            overflow: hidden; /* Rimuove gli scroll bar per evitare overflow */
            box-sizing: border-box; /* Il calcolo della dimensione include padding e border */
            background-color: black;
        }
        /* Assicura che il terminale occupi tutto lo spazio disponibile */
        #terminal {
            width: 100vw; /* 100% della larghezza del viewport */
            height: 100vh; /* 100% dell'altezza del viewport */
            overflow: hidden; /* Previene lo scroll interno se non necessario */
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            scrollback: 1000,
            tabStopWidth: 8,
            rendererType: 'dom',
            convertEol: true,
            disableStdin: false,
            allowTransparency: true,
            fontSize: 14,
            fontFamily: 'monospace',
            theme: {
                background: '#000000',
                foreground: '#FFFFFF'
            }
        });
        term.open(document.getElementById('terminal'));

        let inputBuffer = "";
        let commandHistory = [];
        let historyIndex = -1;

        const guestUser = "guest";
        const machineName = "machine";

        function writePrompt() {
            term.write(`\\r\\n[${guestUser}@${machineName} $] `);
        }

        function sendCommand(command) {
            command = command.trim();
            if (command.length === 0) {
                writePrompt();
                return;
            }
            commandHistory.push(command);
            historyIndex = commandHistory.length;

            fetch('http://localhost:5501/api/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                },
                body: JSON.stringify({ input: command })
            })
            .then(response => response.json())
            .then(data => {
                term.write('\\r\\n' + data.output);
                writePrompt();
            })
            .catch(error => {
                console.error('Error sending command:', error);
                term.write('\\r\\nAn error occurred.');
                writePrompt();
            });
        }

        term.onKey(e => {
            const { key, domEvent } = e;
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

            if (domEvent.keyCode === 13) {
                term.write('\\r\\n');
                sendCommand(inputBuffer);
                inputBuffer = '';
            } else if (domEvent.keyCode === 8) {
                if (term.buffer.active.cursorX > 2) {
                    term.write('\\b \\b');
                    inputBuffer = inputBuffer.slice(0, -1);
                }
            } else if (domEvent.keyCode === 38) {
                if (historyIndex > 0) {
                    historyIndex--;
                    inputBuffer = commandHistory[historyIndex];
                    term.write('\\r\\x1b[K');
                    writePrompt();
                    term.write(inputBuffer);
                }
            } else if (domEvent.keyCode === 40) {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    inputBuffer = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    inputBuffer = '';
                }
                term.write('\\r\\x1b[K');
                writePrompt();
                term.write(inputBuffer);
            } else if (printable) {
                term.write(key);
                inputBuffer += key;
            }
        });

        writePrompt();
    </script>
</body>
</html>
